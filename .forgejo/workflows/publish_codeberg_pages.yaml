name: Publish to Codeberg Pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  publish_html:
    name: "publish html"
    runs-on: codeberg-tiny
    steps:
      - uses: actions/checkout@v6

      - uses: https://github.com/actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install tester
        run: wget "https://github.com/sib-swiss/sparql-examples-utils/releases/download/v2.0.23/sparql-examples-utils-2.0.23-uber.jar" -O sparql-examples-utils-uber.jar

      - name: Generate markdown
        run: java -jar sparql-examples-utils-uber.jar convert -i examples/ -m

      - name: Generate rq files
        run: java -jar sparql-examples-utils-uber.jar convert -i examples/ -r

      - name: Download modernist theme
        run: |
          mkdir -p _layouts assets/css assets/js
          wget "https://raw.githubusercontent.com/pages-themes/modernist/master/_layouts/default.html" -O _layouts/default.html
          wget "https://pages-themes.github.io/modernist/assets/css/style.css" -O assets/css/style.css
          wget "https://raw.githubusercontent.com/pages-themes/modernist/master/assets/js/scale.fix.js" -O assets/js/scale.fix.js

      - name: Fix theme footer
        run: |
          python3 -c "
          import pathlib
          f = pathlib.Path('_layouts/default.html')
          content = f.read_text()
          content = content.replace(
            'Hosted on GitHub Pages &mdash; Theme by <a href=\"https://github.com/orderedlist\">orderedlist</a>',
            'Hosted on <a href=\"https://codeberg.org\">Codeberg</a>'
          )
          f.write_text(content)
          "

      - name: Fix generated URLs
        run: |
          find . -name "*.md" ! -path "./_site/*" -exec sed -i 's|/pages/adafede/sparql-examples/|/sparql-examples/|g' {} +

      - name: Write Jekyll config
        run: |
          cat > _config.yml << 'EOF'
          baseurl: "/sparql-examples"
          url: "https://adafede.codeberg.page"
          theme: null
          plugins:
            - jekyll-seo-tag
          EOF

      - name: Build with Jekyll
        uses: https://github.com/actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: Deploy to Codeberg Pages
        uses: actions/git-pages@v2
        with:
          site: https://adafede.codeberg.page/sparql-examples/
          token: ${{ forge.token }}
          source: ./_site